---
layout: post
title: "55 Vulnerabilities in Squid Caching Proxies and 35 0days"
author: "Joshua Rogers"
categories: security
---

In 2021, I performed a security audit of [The Squid Caching Proxy](https://github.com/squid-cache/squid). Squid is by far the most well known open-source forwarding HTTP proxy, and is used in many contexts, like corporations that want to filter or cache content, companies that claim to provide a "VPN", hobbyists, and even a few website use Squid as a reverse proxy. There are currently over 2.5 million instances available on the internet.

Using various techniques such as fuzzing, manual code review and static analysis, I discovered 55 security vulnerabilities (as well as 26 non-security bugs). Along the way, I also added Leak Sanitizer (LSAN) [support to AFL++](https://github.com/AFLplusplus/AFLplusplus/pull/855), and had some fun with some new techniques like setting up parallel fuzzing [using network files systems](https://joshua.hu/fuzzing-multiple-servers-parallel-aflplusplus-nfs).

---

The majority of these vulnerabilities have not been fixed. All vulnerabilities were discovered in squid-5.0.5. Tests were done in nearly every component possible: forward proxying, reverse proxying, all protocols supports (http, https, https intercept, urn, whois, gopher, ftp), responses, requests, "helpers", DNS, ICAP, ESI, and caching. Every conceivable possible user and build configuration was used.

Taking this systematic and exhaustive approach is generally how I approach any audit. If you have any interesting projects like this one, I'm always available [for rent](/contact.html).

Although I would normally discuss the vulnerabilities on this blog, there are simply too many to go over in one post. Luckily back in 2021, I outlined the issues and PoCs for __most__ of the vulnerabilities. The vulnerabilities, their detailed explanations, and PoCs can be found on my [GitHub](https://megamansec.github.io/Squid-Security-Audit).

The Squid Team have been helpful and supportive during the process of reporting these issues. However, they are effectively understaffed, and simply do not have the resources to fix the discovered issues. Hammering them with demands to fix the issues won't get far.

---

With any system or project, it is important to reguarly review solutions used in your stack to determine whether they are still appropriate. If you are running Squid in an environment which may suffer from any of these issues, then it is up to you to reassess whether Squid is the right solution for your system.

---

## Vulnerabilities

|  Vulnerability| ID |
|--|--|
| [Stack Buffer Overflow in Digest Authentication](https://megamansec.github.io/Squid-Security-Audit/digest-overflow.html)| |
| [Use-After-Free in TRACE Requests](https://megamansec.github.io/Squid-Security-Audit/trace-uaf.html)| |
| [Partial Content Parsing Use-After-Free](https://megamansec.github.io/Squid-Security-Audit/range-uaf.html)|[CVE-2021-31807](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-31807) |
| [X-Forwarded-For Stack Overflow](https://megamansec.github.io/Squid-Security-Audit/xff-stackoverflow.html)| |
| [Chunked Encoding Stack Overflow](https://megamansec.github.io/Squid-Security-Audit/chunked-stackoverflow.html)| |
| [Use-After-Free in Cache Manager Errors](https://megamansec.github.io/Squid-Security-Audit/cache-uaf.html)| |
| [Cache Poisoning by Large Stored Response Headers (With Bonus XSS)](https://megamansec.github.io/Squid-Security-Audit/cache-headers.html)| |
| [Memory Leak in CacheManager URI Parsing](https://megamansec.github.io/Squid-Security-Audit/cachemanager-memleak.html)|[CVE-2021-28652](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-28652) |
| [RFC 2141 / 2169 (URN) Response Parsing Memory Leak](https://megamansec.github.io/Squid-Security-Audit/urn-memleak.html)| [CVE-2021-28651](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-28651)|
| [Memory Leak in HTTP Response Parsing](https://megamansec.github.io/Squid-Security-Audit/response-memleaks.html)| |
| [Memory Leak in ESI Error Processing](https://megamansec.github.io/Squid-Security-Audit/esi-memleak.html)| |
| [1-Byte Buffer OverRead in RFC 1123 date/time Handling](https://megamansec.github.io/Squid-Security-Audit/datetime-overflow.html)| |
| [Null Pointer Dereference in Gopher Response Handling](https://megamansec.github.io/Squid-Security-Audit/gopher-nullpointer.html)| [GHSA-cg5h-v6vc-w33f](https://github.com/squid-cache/squid/security/advisories/GHSA-cg5h-v6vc-w33f) |
| [One-Byte Buffer OverRead  in HTTP Request Header Parsing](https://megamansec.github.io/Squid-Security-Audit/garbage-overflow.html)| |
| [strlen(NULL) Crash Using Digest Authentication](https://megamansec.github.io/Squid-Security-Audit/digest-strlen-null.html)| |
| [Assertion in ESI Header Handling](https://megamansec.github.io/Squid-Security-Audit/esi-assert-header.html)| |
| [Integer Overflow in Range Header](https://megamansec.github.io/Squid-Security-Audit/range-assert-int.html)|[CVE-2021-31808](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-31808) |
| [Gopher Assertion Crash](https://megamansec.github.io/Squid-Security-Audit/gopher-assert-entry.html)| |
| [Whois Assertion Crash](https://megamansec.github.io/Squid-Security-Audit/whois-assert-entry.html)| |
| [Assertion in Gopher Response Handling](https://megamansec.github.io/Squid-Security-Audit/gopher-assert.html)| |
| [RFC 2141 / 2169 (URN) Assertion Crash](https://megamansec.github.io/Squid-Security-Audit/urn-assert.html)| |
| [Vary: Other HTTP Response Assertion Crash](https://megamansec.github.io/Squid-Security-Audit/vary-other-assert.html)|[CVE-2021-28662](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-28662) |
| [Assertion in Negotiate/NTLM Authentication Using Pipeline Prefetching](https://megamansec.github.io/Squid-Security-Audit/ntlm-negotiate-assert.html)| |
| [Assertion on IPv6 Host Requests with --disable-ipv6](https://megamansec.github.io/Squid-Security-Audit/ipv6-assert.html)| |
| [Assertion Crash on Unexpected "HTTP/1.1 100 Continue" Response Header](https://megamansec.github.io/Squid-Security-Audit/100-continue-entry-assert.html)| |
| [Pipeline Prefetch Assertion With Double 'Expect:100-continue' Request Headers](https://megamansec.github.io/Squid-Security-Audit/expect-100-assert.html)| |
| [Pipeline Prefetch Assertion With Invalid Headers](https://megamansec.github.io/Squid-Security-Audit/expect-100-invalid-headers-assert.html)| |
| [Assertion Crash in Deferred Requests](https://megamansec.github.io/Squid-Security-Audit/defer-assert.html)| |
| [Assertion in Digest Authentication](https://megamansec.github.io/Squid-Security-Audit/digest-assert.html)| |
| [FTP URI Assertion](https://megamansec.github.io/Squid-Security-Audit/ftp-assert.html)| |
| [FTP Authentication Crash](https://megamansec.github.io/Squid-Security-Audit/ftp-fatal.html)| |
| [Unsatisfiable Range Requests Assertion](https://megamansec.github.io/Squid-Security-Audit/range-assert.html)|[CVE-2021-31806](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-31806) |
| [Crash in Content-Range Response Header Logic](https://megamansec.github.io/Squid-Security-Audit/range-fatal.html)|[CVE-2021-33620](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-33620) |
| [Assertion Crash In HTTP Response Headers Handling](https://megamansec.github.io/Squid-Security-Audit/response-assertion.html)| |
| [Implicit Assertion in Stream Handling](https://megamansec.github.io/Squid-Security-Audit/stream-assert.html)| |
| [Buffer UnderRead in SSL CN Parsing](https://megamansec.github.io/Squid-Security-Audit/ssl-bufferunderread.html)| |
| [Use-After-Free in ESI 'Try' (and 'Choose') Processing ](https://megamansec.github.io/Squid-Security-Audit/esi-uaf-crash.html)| |
| [Use-After-Free in ESI Expression Evaluation ](https://megamansec.github.io/Squid-Security-Audit/esi-uaf.html)| |
| [Buffer Underflow in ESI ](https://megamansec.github.io/Squid-Security-Audit/esi-underflow.html)| |
| [Assertion in Squid "Helper" Process Creator](https://megamansec.github.io/Squid-Security-Audit/ipc-assert.html)| |
| [Assertion Due to 0 ESI 'when' Checking ](https://megamansec.github.io/Squid-Security-Audit/esi-when-assert-0.html)| |
| [Assertion Using ESI's When Directive ](https://megamansec.github.io/Squid-Security-Audit/esi-when-assert-1.html)| |
| [Assertion in ESI Variable Assignment (String)](https://megamansec.github.io/Squid-Security-Audit/esi-assignassert-2.html)| |
| [Assertion in ESI Variable Assignment](https://megamansec.github.io/Squid-Security-Audit/esi-assignassert.html)| |
| [Null Pointer Dereference In ESI's esi:include and esi:when ](https://megamansec.github.io/Squid-Security-Audit/esi-nullpointer.html)| |

## Bugs

In addition to the above vulnerabilities, the following bugs were discovered which did not indicate direct security impact:

- Uninitialised Memory Read in hdrCacheInit
- Excessively Loud Chunked Parsing Error
- Buffer Overflow During errorInitialize() using SSL
- Assertion in ipcCreate Due to dup() Failure.
- Invalid Free in helperStatefulHandleRead()
- Uninitialised Memory Read in UFSSwapDir()
- Excessively Loud Chunked Reply Error Reporting
- Assertion Due to url_rewrite_children Option
- Clang-12.0 Compiler Errors
- 18x Undefined Behaviour in Squid / Other Reports
- Buffer Overflow Due to Undefined Behavior
- Warning Header Breaks RFC 7230
- Logging Level-2 Broken

