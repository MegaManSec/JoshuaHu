---
layout: post
title: "55 Vulnerabilities in Squid Caching Proxies: 35 0days"
author: "Joshua Rogers"
categories: security
---
Over some period in 2021, I began testing the security of The Squid Caching Proxy. With its history spanning back to 1996, Squid is by the most well known open source forwarding HTTP proxy. According to Shodan, there are over 2.5 million instances available on the internet. You'll find Squid being used in many places like corporations that want to filter or cache content, companies that claim to provide a "VPN", or even the few that use Squid as a reverse proxy. Some commerical products use Squid under-the-hood, too.

Using various techniques such as fuzzing, manual code review and static analysis, I discovered 55 security vulnerabilities (as well as 26 non-security bugs). Along the way, I also added Leak Sanitizer (LSAN) [support to AFL++](https://github.com/AFLplusplus/AFLplusplus/pull/855), and had some fun with some new techniques like setting up parallel fuzzing [using network files systems](https://joshua.hu/fuzzing-multiple-servers-parallel-aflplusplus-nfs).

The majority of these vulnerabilities still exist. However, after two and a half years of waiting for fixes, I believe there is no reason to keep the vulnerabilities a secret any longer.

All vulnerabilities were tested in squid-5.0.5. Tests were done in nearly every component possible: forward proxying, reverse proxying, all protocols supports (http, https, https intercept, urn, whois, gopher, ftp), responses, requests, "helpers", DNS, ICAP, ESI, and caching. Every conceivable possible user and build configuration was used. As always, I to took a systematic and exhaustive approach which seemed to have paid off quite well.

Although I would normally discuss the vulnerabilities on this blog, there are simply too many to go over in one post. Luckily back in 2021, I outlined the issues and PoCs for __most__ of the vulnerabilities. The vulnerabilities, their detailed explanations, and PoCs can be found on my Github.

## Vulnerabilities

|  Vulnerability| ID |
|--|--|
| [Stack Buffer Overflow in Digest Authentication](https://megamansec.github.io/Squid-Security-Audit/digest-overflow.md)| |
| [Use-After-Free in TRACE Requests](https://megamansec.github.io/Squid-Security-Audit/trace-uaf.md)| |
| [Partial Content Parsing Use-After-Free](https://megamansec.github.io/Squid-Security-Audit/range-uaf.md)|[CVE-2021-31807](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-31807) |
| [X-Forwarded-For Stack Overflow](https://megamansec.github.io/Squid-Security-Audit/xff-stackoverflow.md)| |
| [Chunked Encoding Stack Overflow](https://megamansec.github.io/Squid-Security-Audit/chunked-stackoverflow.md)| |
| [Use-After-Free in Cache Manager Errors](https://megamansec.github.io/Squid-Security-Audit/cache-uaf.md)| |
| [Cache Poisoning by Large Stored Response Headers (With Bonus XSS)](https://megamansec.github.io/Squid-Security-Audit/cache-headers.md)| |
| [Memory Leak in CacheManager URI Parsing](https://megamansec.github.io/Squid-Security-Audit/cachemanager-memleak.md)|[CVE-2021-28652](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-28652) |
| [RFC 2141 / 2169 (URN) Response Parsing Memory Leak](https://megamansec.github.io/Squid-Security-Audit/urn-memleak.md)| [CVE-2021-28651](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-28651)|
| [Memory Leak in HTTP Response Parsing](https://megamansec.github.io/Squid-Security-Audit/response-memleaks.md)| |
| [Memory Leak in ESI Error Processing](https://megamansec.github.io/Squid-Security-Audit/esi-memleak.md)| |
| [1-Byte Buffer OverRead in RFC 1123 date/time Handling](https://megamansec.github.io/Squid-Security-Audit/datetime-overflow.md)| |
| [Null Pointer Dereference in Gopher Response Handling](https://megamansec.github.io/Squid-Security-Audit/gopher-nullpointer.md)| [GHSA-cg5h-v6vc-w33f](https://github.com/squid-cache/squid/security/advisories/GHSA-cg5h-v6vc-w33f) |
| [One-Byte Buffer OverRead  in HTTP Request Header Parsing](https://megamansec.github.io/Squid-Security-Audit/garbage-overflow.md)| |
| [strlen(NULL) Crash Using Digest Authentication](https://megamansec.github.io/Squid-Security-Audit/digest-strlen-null.md)| |
| [Assertion in ESI Header Handling](https://megamansec.github.io/Squid-Security-Audit/esi-assert-header.md)| |
| [Integer Overflow in Range Header](https://megamansec.github.io/Squid-Security-Audit/range-assert-int.md)|[CVE-2021-31808](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-31808) |
| [Gopher Assertion Crash](https://megamansec.github.io/Squid-Security-Audit/gopher-assert-entry.md)| |
| [Whois Assertion Crash](https://megamansec.github.io/Squid-Security-Audit/whois-assert-entry.md)| |
| [Assertion in Gopher Response Handling](https://megamansec.github.io/Squid-Security-Audit/gopher-assert.md)| |
| [RFC 2141 / 2169 (URN) Assertion Crash](https://megamansec.github.io/Squid-Security-Audit/urn-assert.md)| |
| [Vary: Other HTTP Response Assertion Crash](https://megamansec.github.io/Squid-Security-Audit/vary-other-assert.md)|[CVE-2021-28662](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-28662) |
| [Assertion in Negotiate/NTLM Authentication Using Pipeline Prefetching](https://megamansec.github.io/Squid-Security-Audit/ntlm-negotiate-assert.md)| |
| [Assertion on IPv6 Host Requests with --disable-ipv6](https://megamansec.github.io/Squid-Security-Audit/ipv6-assert.md)| |
| [Assertion Crash on Unexpected "HTTP/1.1 100 Continue" Response Header](https://megamansec.github.io/Squid-Security-Audit/100-continue-entry-assert.md)| |
| [Pipeline Prefetch Assertion With Double 'Expect:100-continue' Request Headers](https://megamansec.github.io/Squid-Security-Audit/expect-100-assert.md)| |
| [Pipeline Prefetch Assertion With Invalid Headers](https://megamansec.github.io/Squid-Security-Audit/expect-100-invalid-headers-assert.md)| |
| [Assertion Crash in Deferred Requests](https://megamansec.github.io/Squid-Security-Audit/defer-assert.md)| |
| [Assertion in Digest Authentication](https://megamansec.github.io/Squid-Security-Audit/digest-assert.md)| |
| [FTP URI Assertion](https://megamansec.github.io/Squid-Security-Audit/ftp-assert.md)| |
| [FTP Authentication Crash](https://megamansec.github.io/Squid-Security-Audit/ftp-fatal.md)| |
| [Unsatisfiable Range Requests Assertion](https://megamansec.github.io/Squid-Security-Audit/range-assert.md)|[CVE-2021-31806](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-31806) |
| [Crash in Content-Range Response Header Logic](https://megamansec.github.io/Squid-Security-Audit/range-fatal.md)|[CVE-2021-33620](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-33620) |
| [Assertion Crash In HTTP Response Headers Handling](https://megamansec.github.io/Squid-Security-Audit/response-assertion.md)| |
| [Implicit Assertion in Stream Handling](https://megamansec.github.io/Squid-Security-Audit/stream-assert.md)| |
| [Buffer UnderRead in SSL CN Parsing](https://megamansec.github.io/Squid-Security-Audit/ssl-bufferunderread.md)| |
| [Use-After-Free in ESI 'Try' (and 'Choose') Processing ](https://megamansec.github.io/Squid-Security-Audit/esi-uaf-crash.md)| |
| [Use-After-Free in ESI Expression Evaluation ](https://megamansec.github.io/Squid-Security-Audit/esi-uaf.md)| |
| [Buffer Underflow in ESI ](https://megamansec.github.io/Squid-Security-Audit/esi-underflow.md)| |
| [Assertion in Squid "Helper" Process Creator](https://megamansec.github.io/Squid-Security-Audit/ipc-assert.md)| |
| [Assertion Due to 0 ESI 'when' Checking ](https://megamansec.github.io/Squid-Security-Audit/esi-when-assert-0.md)| |
| [Assertion Using ESI's When Directive ](https://megamansec.github.io/Squid-Security-Audit/esi-when-assert-1.md)| |
| [Assertion in ESI Variable Assignment (String)](https://megamansec.github.io/Squid-Security-Audit/esi-assignassert-2.md)| |
| [Assertion in ESI Variable Assignment](https://megamansec.github.io/Squid-Security-Audit/esi-assignassert.md)| |
| [Null Pointer Dereference In ESI's esi:include and esi:when ](https://megamansec.github.io/Squid-Security-Audit/esi-nullpointer.md)| |

## Bugs

In addition to the above vulnerabilities, the following bugs were discovered which did not without direct security impact:

- Uninitialised Memory Read in hdrCacheInit
- Excessively Loud Chunked Parsing Error
- Buffer Overflow During errorInitialize() using SSL
- Assertion in ipcCreate Due to dup() Failure.
- Invalid Free in helperStatefulHandleRead()
- Uninitialised Memory Read in UFSSwapDir()
- Excessively Loud Chunked Reply Error Reporting
- Assertion Due to url_rewrite_children Option
- Clang-12.0 Compiler Errors
- 18x Undefined Behaviour in Squid / Other Reports
- Buffer Overflow Due to Undefined Behavior
- Warning Header Breaks RFC 7230
- Logging Level-2 Broken

